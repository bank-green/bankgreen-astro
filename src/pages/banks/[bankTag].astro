---
import { BankScorePage } from '@components/pages'
import BaseLayout from '@layouts/BaseLayout.astro'
import { getDefaultFields } from '@lib/banks'
import { getByUIDSafe, prismicClient } from '@lib/prismic'
import { fetchBrandByTag } from '@lib/queries/brands'

// Full SSR - all bank routes handled dynamically
// This ensures every bank works, not just those known at build time

interface BankData {
  name: string
  tag: string
  website?: string | null
  commentary?: {
    rating?: string | null
    ratingInherited?: boolean | null
    inheritBrandRating?: {
      tag: string
      name: string
    } | null
    lastReviewed?: string | null
    headline?: string | null
    description1?: string | null
    description2?: string | null
    description3?: string | null
    fossilFreeAlliance?: boolean | null
    showOnSustainableBanksPage?: boolean
    institutionType?: {
      name: string
    } | null
  } | null
  countries?: Array<{ code: string }> | null
}

const { bankTag } = Astro.params

// Fetch bank data from GraphQL
const bank = await fetchBrandByTag(bankTag as string)

// Redirect to 404 if bank not found
if (!bank) {
  return Astro.redirect('/404')
}

const bankName = bank.name
const title = `${bankName}'s Climate Score`

// If this bank inherits its rating from a parent brand, fetch the parent's rating
let effectiveRating = bank.commentary?.rating || 'unknown'

if (bank.commentary?.ratingInherited && bank.commentary?.inheritBrandRating?.tag) {
  const parentBrand = await fetchBrandByTag(bank.commentary.inheritBrandRating.tag)
  if (parentBrand?.commentary?.rating) {
    effectiveRating = parentBrand.commentary.rating
  }
}

// Handle credit union logic
const getRating = (rating: string, bank: BankData): string => {
  const institutionType = bank.commentary?.institutionType?.name
  const isCreditUnion = institutionType === 'Credit Union'
  const isRatingUnknown = rating === 'unknown'

  // Credit unions with unknown rating default to 'good'
  if (isCreditUnion && isRatingUnknown) {
    return 'good'
  }

  return rating
}

const rating = getRating(effectiveRating, bank)
const institutionType = bank.commentary?.institutionType?.name || 'Bank'

// Fetch Prismic defaults based on rating
const prismicDefaults = await getDefaultFields(prismicClient, rating, bankName, institutionType)

// Fetch Prismic page for SliceZone
const queryKey =
  rating === 'unknown'
    ? `unknownbank-${institutionType.toLowerCase().replace(/\s/g, '')}`
    : `${rating}bank`
const prismicPage = await getByUIDSafe('bankpage', queryKey)
const prismicNotListed = await getByUIDSafe('textonlypages', 'notlisted')
---

<BaseLayout title={title}>
  <BankScorePage bank={bank} rating={rating} prismicDefaults={prismicDefaults} prismicPage={prismicPage} prismicNotListed={prismicNotListed} client:load />
</BaseLayout>
