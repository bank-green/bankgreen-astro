---
import { EcoBankProfilePage } from '@components/pages'
import BaseLayout from '@layouts/BaseLayout.astro'
import { getByUIDSafe, prismicClient } from '@lib/prismic'
import { fetchAllSustainableBankTags, fetchBrandByTag, fetchHarvestData } from '@lib/queries/brands'

export const prerender = true

export async function getStaticPaths() {
  const tags = await fetchAllSustainableBankTags()
  return tags.map((tag) => ({ params: { bankTag: tag } }))
}

const { bankTag } = Astro.params

// Fetch bank data from GraphQL
const bank = await fetchBrandByTag(bankTag as string)

// Redirect to 404 if bank not found
if (!bank) {
  return Astro.redirect('/404')
}

// Fetch harvest data
const harvestData = await fetchHarvestData(bankTag as string)

// Fetch Prismic data (sfipage) for editorial content
const prismicData = await getByUIDSafe('sfipage', bankTag as string)

// Fetch Prismic defaults for institution credential images
const prismicDefaults = await prismicClient.getByID('ZFpGfhEAACEAuFIf').catch(() => null)

// If this bank inherits its rating from a parent brand, fetch the parent's rating
let rating = bank.commentary?.rating || 'unknown'

if (bank.commentary?.ratingInherited && bank.commentary?.inheritBrandRating?.tag) {
  const parentBrand = await fetchBrandByTag(bank.commentary.inheritBrandRating.tag)
  if (parentBrand?.commentary?.rating) {
    rating = parentBrand.commentary.rating
  }
}

const bankName = bank.name
const title = `${bankName} Review and Service Offering`
const description = `Learn about ${bankName}'s environmental rating, services, and sustainable banking options.`
---

<BaseLayout title={title} description={description}>
  <EcoBankProfilePage bank={bank} rating={rating} harvestData={harvestData} prismicData={prismicData} prismicDefaults={prismicDefaults} client:load />
</BaseLayout>
