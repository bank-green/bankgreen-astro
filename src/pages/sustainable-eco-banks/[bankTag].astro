---
import { EcoBankProfilePage } from '@components/pages'
import BaseLayout from '@layouts/BaseLayout.astro'
import { getByUIDSafe, prismicClient } from '@lib/prismic'
import { fetchBrandByTag, fetchHarvestData } from '@lib/queries/brands'

export async function getStaticPaths() {
  // TODO: Fetch all sustainable banks from GraphQL
  // const data = await graphqlFetch(`query { sustainableBanks { tag } }`);
  // return data.sustainableBanks.map((bank) => ({ params: { bankTag: bank.tag } }));
  return []
}

const { bankTag } = Astro.params

// Fetch bank data from GraphQL
const bank = await fetchBrandByTag(bankTag as string)

// Redirect to 404 if bank not found
if (!bank) {
  return Astro.redirect('/404')
}

// Fetch harvest data
const harvestData = await fetchHarvestData(bankTag as string)

// Fetch Prismic data (sfipage) for editorial content
const prismicData = await getByUIDSafe('sfipage', bankTag as string)

// Fetch Prismic defaults for institution credential images
const prismicDefaults = await prismicClient.getByID('ZFpGfhEAACEAuFIf').catch(() => null)

const bankName = bank.name
const title = `${bankName} Review and Service Offering`
const description = `Learn about ${bankName}'s environmental rating, services, and sustainable banking options.`
---

<BaseLayout title={title} description={description}>
  <EcoBankProfilePage bank={bank} harvestData={harvestData} prismicData={prismicData} prismicDefaults={prismicDefaults} client:load />
</BaseLayout>
